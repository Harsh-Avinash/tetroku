(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(t){if(t.ep)return;t.ep=!0;const n=i(t);fetch(t.href,n)}})();class I{game;renderer;isDragging;draggedPiece;dragElement;startPos;lastValidPos;constructor(e,i){this.game=e,this.renderer=i,this.isDragging=!1,this.draggedPiece=null,this.dragElement=null,this.startPos={x:0,y:0},this.lastValidPos=null,this.setupEventListeners()}setupEventListeners(){document.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),document.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd.bind(this))}handleMouseDown(e){if(this.game.gameOver||this.game.isProcessing)return;const i=e.target.closest(".hand-piece");if(!i)return;e.preventDefault();const s=i.dataset.index;if(s){const t=parseInt(s);this.startDrag(t,e.clientX,e.clientY)}}handleTouchStart(e){if(this.game.gameOver||this.game.isProcessing)return;const i=e.touches[0],s=i.target.closest(".hand-piece");if(!s)return;e.preventDefault();const t=s.dataset.index;if(t){const n=parseInt(t);this.startDrag(n,i.clientX,i.clientY)}}startDrag(e,i,s){this.isDragging=!0,this.draggedPiece={index:e},this.lastValidPos=null;const n=document.querySelectorAll(".hand-piece")[e];n&&n.classList.add("dragging"),this.handleDragMove(i,s)}getGridPosition(e,i){const s=this.renderer.gridContainer;if(!s)return null;const t=s.getBoundingClientRect(),n=30;if(e<t.left-n||e>t.right+n||i<t.top-n||i>t.bottom+n)return null;const r=window.getComputedStyle(s),a=parseFloat(r.paddingLeft)||0,l=parseFloat(r.paddingTop)||0,d=parseFloat(r.gap)||3;let f=38;const o=s.querySelector(".grid-cell");o&&(f=o.offsetWidth);const h=f+d,p=e-t.left-a,u=i-t.top-l;let g=Math.floor(p/h),c=Math.floor(u/h);return g<0&&(g=0),g>=this.game.GRID_SIZE&&(g=this.game.GRID_SIZE-1),c<0&&(c=0),c>=this.game.GRID_SIZE&&(c=this.game.GRID_SIZE-1),{x:g,y:c}}handleMouseMove(e){!this.isDragging||!this.draggedPiece||this.handleDragMove(e.clientX,e.clientY)}handleTouchMove(e){if(!this.isDragging||!this.draggedPiece)return;e.preventDefault();const i=e.touches[0];this.handleDragMove(i.clientX,i.clientY)}handleDragMove(e,i){const s=this.getGridPosition(e,i),t=this.game.hand[this.draggedPiece.index],n=t.length,r=t[0].length,a=(d,f)=>{const o=d-Math.floor(r/2),h=f-Math.floor(n/2);return{isValid:this.game.validatePlacement(o,h,t),targetX:o,targetY:h}};let l=null;if(s){const d=a(s.x,s.y);if(d.isValid)l={x:d.targetX,y:d.targetY,dist:0};else for(let o=-2;o<=2;o++)for(let h=-2;h<=2;h++){if(h===0&&o===0)continue;const p=s.x+h,u=s.y+o;if(p<0||p>=this.game.GRID_SIZE||u<0||u>=this.game.GRID_SIZE)continue;const g=a(p,u);if(g.isValid){const c=Math.sqrt(h*h+o*o);(!l||c<l.dist)&&(l={x:g.targetX,y:g.targetY,dist:c})}}}l?(this.lastValidPos={x:l.x,y:l.y},this.game.previewPlacement(l.x,l.y,this.draggedPiece.index)):this.lastValidPos?this.game.previewPlacement(this.lastValidPos.x,this.lastValidPos.y,this.draggedPiece.index):this.game.clearPreview()}updateDragPosition(e,i){}async handleMouseUp(e){await this.handleDragEnd(e.clientX,e.clientY)}async handleTouchEnd(e){if(!this.isDragging)return;e.preventDefault();const i=e.changedTouches[0];await this.handleDragEnd(i.clientX,i.clientY)}async handleDragEnd(e,i){if(!this.isDragging||!this.draggedPiece)return;const s=this.draggedPiece.index,n=document.querySelectorAll(".hand-piece")[s];n&&n.classList.remove("dragging"),this.isDragging=!1,this.draggedPiece=null,this.dragElement=null,this.game.clearPreview(),this.lastValidPos&&await this.game.placePiece(this.lastValidPos.x,this.lastValidPos.y,s),this.lastValidPos=null}}const v={I:[[1,1,1,1]],J:[[1,0,0],[1,1,1]],L:[[0,0,1],[1,1,1]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0]],T:[[0,1,0],[1,1,1]],Z:[[1,1,0],[0,1,1]],ONE:[[1]],TWO:[[1,1]],THREE:[[1,1,1]],RECT2x3:[[1,1,1],[1,1,1]],NINE:[[1,1,1],[1,1,1],[1,1,1]]};class y{renderer;GRID_SIZE;grid;gridAges;hand;bag;inputHandler;score;turnCount;roundCount;gameOver;timerInterval;isProcessing;startTime;elapsedTime;constructor(e){this.renderer=e,this.GRID_SIZE=7,this.grid=Array(this.GRID_SIZE).fill(null).map(()=>Array(this.GRID_SIZE).fill(0)),this.gridAges=Array(this.GRID_SIZE).fill(null).map(()=>Array(this.GRID_SIZE).fill(0)),this.score=0,this.turnCount=0,this.roundCount=1,this.gameOver=!1,this.isProcessing=!1,this.hand=[],this.bag=[],this.startTime=Date.now(),this.elapsedTime=0,this.generateInitialBlocks(),this.refillHand(),this.inputHandler=new I(this,e)}start(){console.log("Game started"),this.score=0,this.turnCount=0,this.roundCount=0,this.gameOver=!1,this.isProcessing=!1,this.startTime=Date.now(),this.elapsedTime=0,this.generateInitialBlocks(),this.refillHand(),this.renderer.render(this),this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{this.gameOver||(this.elapsedTime++,this.renderer.updateTime(this.elapsedTime))},1e3)}refillHand(){this.roundCount++,this.renderer.updateRounds(this.roundCount),this.hand=[];for(let e=0;e<3;e++)this.hand.push(this.getRandomPiece())}restart(){this.start(),this.renderer.hideGameOver()}rotateShape(e){const i=e.length,s=e[0].length,t=Array(s).fill(null).map(()=>Array(i).fill(0));for(let n=0;n<i;n++)for(let r=0;r<s;r++)t[r][i-1-n]=e[n][r];return t}refillBag(){const e=Object.keys(v);this.bag=[...e,...e];for(let i=this.bag.length-1;i>0;i--){const s=Math.floor(Math.random()*(i+1));[this.bag[i],this.bag[s]]=[this.bag[s],this.bag[i]]}}getRandomPiece(){this.bag.length===0&&this.refillBag();const e=this.bag.pop();let i=v[e];i||(i=v.T);const s=Math.floor(Math.random()*4);for(let t=0;t<s;t++)i=this.rotateShape(i);return i}validatePlacement(e,i,s){const t=s.length,n=s[0].length;for(let r=0;r<t;r++)for(let a=0;a<n;a++)if(s[r][a]===1){const l=e+a,d=i+r;if(l<0||l>=this.GRID_SIZE||d<0||d>=this.GRID_SIZE||this.grid[d][l]!==0)return!1}return!0}async placePiece(e,i,s){if(this.gameOver||this.isProcessing)return!1;const t=this.hand[s];if(!t||!this.validatePlacement(e,i,t))return!1;this.isProcessing=!0,this.turnCount++;const n=t.length,r=t[0].length;for(let a=0;a<n;a++)for(let l=0;l<r;l++)t[a][l]===1&&(this.grid[i+a][e+l]=1,this.gridAges[i+a][e+l]=this.roundCount);return this.hand.splice(s,1),this.renderer.updateGrid(this),this.renderer.updateHand(this),await this.checkClears(),this.hand.length===0&&(this.refillHand(),this.renderer.updateHand(this),this.renderer.updateGrid(this)),this.checkGameOver()?(console.log("Game Over state detected!"),this.gameOver=!0,this.timerInterval&&clearInterval(this.timerInterval),this.renderer.showInterstitialGameOver(this.score,this.elapsedTime)):this.isProcessing=!1,!0}async checkClears(){const e={rows:[],cols:[]};for(let s=0;s<this.GRID_SIZE;s++)this.grid[s].every(t=>t!==0)&&e.rows.push(s);for(let s=0;s<this.GRID_SIZE;s++){let t=!0;for(let n=0;n<this.GRID_SIZE;n++)if(this.grid[n][s]===0){t=!1;break}t&&e.cols.push(s)}if(e.rows.length+e.cols.length>0){console.log("Clearing with Aging:",e),await this.renderer.animateClears(e);let s=0;const t=new Set,n=(r,a)=>{const l=`${r},${a}`;if(t.has(l))return;t.add(l);const d=this.gridAges[a][r],f=this.roundCount-d;let o=0;f>=10?o=50:f>=8?o=30:f>=5?o=20:o=0,s+=o};e.rows.forEach(r=>{for(let a=0;a<this.GRID_SIZE;a++)n(a,r);this.grid[r].fill(0),this.gridAges[r].fill(0)}),e.cols.forEach(r=>{for(let a=0;a<this.GRID_SIZE;a++)n(r,a);for(let a=0;a<this.GRID_SIZE;a++)this.grid[a][r]=0,this.gridAges[a][r]=0}),this.score+=s,this.renderer.updateScore(this.score),this.renderer.updateGrid(this)}}generateInitialBlocks(){this.grid=Array(this.GRID_SIZE).fill(null).map(()=>Array(this.GRID_SIZE).fill(0)),this.gridAges=Array(this.GRID_SIZE).fill(null).map(()=>Array(this.GRID_SIZE).fill(0));let e=0,i=0;for(;e<5&&i<100;){const s=Math.floor(Math.random()*this.GRID_SIZE),t=Math.floor(Math.random()*this.GRID_SIZE);this.grid[t][s]===0&&(this.grid[t][s]=2,this.gridAges[t][s]=0,e++),i++}}checkGameOver(){if(this.hand.length===0)return!1;for(const e of this.hand)for(let i=0;i<this.GRID_SIZE;i++)for(let s=0;s<this.GRID_SIZE;s++)if(this.validatePlacement(s,i,e))return!1;return console.log("GAME OVER"),!0}previewPlacement(e,i,s){if(this.isProcessing)return;const t=this.hand[s];if(!t)return;const n=this.validatePlacement(e,i,t),r=[],a=t.length,l=t[0].length,d=new Map,f=new Map;for(let p=0;p<a;p++)for(let u=0;u<l;u++)if(t[p][u]===1){const g=e+u,c=i+p;r.push({x:g,y:c}),d.set(c,(d.get(c)||0)+1),f.set(g,(f.get(g)||0)+1)}const o=[],h=[];n&&(d.forEach((p,u)=>{if(u>=0&&u<this.GRID_SIZE){let g=0;for(let c=0;c<this.GRID_SIZE;c++)this.grid[u][c]!==0&&g++;g+p===this.GRID_SIZE&&o.push(u)}}),f.forEach((p,u)=>{if(u>=0&&u<this.GRID_SIZE){let g=0;for(let c=0;c<this.GRID_SIZE;c++)this.grid[c][u]!==0&&g++;g+p===this.GRID_SIZE&&h.push(u)}})),this.renderer.updatePreview(r,n,o,h)}clearPreview(){this.renderer.clearPreview()}}class P{container;scoreElement=null;roundElement=null;timeElement=null;gridContainer=null;handContainer=null;interstitialPopup=null;initialized=!1;constructor(e){this.container=e}initialize(e){this.container.innerHTML="",this.container.style.position="relative";const i=document.createElement("h1");i.innerHTML='Tetroku<span style="color:var(--primary-color)">.io</span>',i.style.textAlign="center",i.style.fontWeight="300",this.container.appendChild(i),this.container.appendChild(i);const s=document.createElement("div");s.className="game-wrapper",this.container.appendChild(s);const t=document.createElement("div");t.className="stats-container";const n=document.createElement("div");n.className="stats-island glass-panel",this.scoreElement=document.createElement("div"),this.scoreElement.className="score-board",this.scoreElement.innerText=`Score: ${e.score||0}`,n.appendChild(this.scoreElement),t.appendChild(n);const r=document.createElement("div");r.className="stats-island glass-panel",this.roundElement=document.createElement("div"),this.roundElement.className="round-board",this.roundElement.innerText=`Round: ${e.roundCount||1}`,r.appendChild(this.roundElement),t.appendChild(r);const a=document.createElement("div");a.className="stats-island glass-panel",this.timeElement=document.createElement("div"),this.timeElement.className="time-board",this.timeElement.innerText="0:00",a.appendChild(this.timeElement),t.appendChild(a),s.appendChild(t),this.gridContainer=document.createElement("div"),this.gridContainer.className="grid-container glass-panel",this.gridContainer.style.gridTemplateColumns=`repeat(${e.GRID_SIZE}, 1fr)`;for(let l=0;l<e.GRID_SIZE;l++)for(let d=0;d<e.GRID_SIZE;d++){const f=document.createElement("div");f.className="grid-cell",f.dataset.x=d.toString(),f.dataset.y=l.toString(),this.gridContainer.appendChild(f)}s.appendChild(this.gridContainer),this.handContainer=document.createElement("div"),this.handContainer.className="hand-container",s.appendChild(this.handContainer),this.createGameOverUI(),this.initialized=!0}createGameOverUI(){this.interstitialPopup=document.createElement("div"),this.interstitialPopup.className="game-over-interstitial glass-panel",this.interstitialPopup.style.display="none",document.body.appendChild(this.interstitialPopup)}render(e){this.initialized||this.initialize(e),this.updateGrid(e),this.updateHand(e),this.updateScore(e.score||0),this.updateRounds(e.roundCount||0),this.updateTime(e.elapsedTime||0),e.gameOver||this.hideGameOver()}updateTime(e){if(this.timeElement){const i=Math.floor(e/60),s=e%60;this.timeElement.innerText=`${i}:${s.toString().padStart(2,"0")}`}}updateGrid(e){if(!this.gridContainer)return;const i=this.gridContainer.children,s=e.grid,t=e.gridAges,n=e.roundCount,r=s.length;for(let a=0;a<r;a++)for(let l=0;l<r;l++){const d=a*r+l,f=i[d],o=s[a][l];let h="";if(o!==0){const g=t[a][l],c=n-g;c>=10?h="tile-age-red":c>=8?h="tile-age-orange":c>=5?h="tile-age-yellow":c>=3?h="tile-age-light-yellow":h="tile-age-green"}const u=`grid-cell ${o?"filled":""} ${o===2?"prefilled":""} ${h}`;f.className=u}}updateHand(e){this.handContainer&&(this.handContainer.innerHTML="",e.hand.forEach((i,s)=>{const t=document.createElement("div");if(t.className="hand-piece glass-panel",t.dataset.index=s.toString(),i){const n=document.createElement("div");n.className="piece-grid",n.style.gridTemplateColumns=`repeat(${i[0].length}, 1fr)`,i.forEach(r=>{r.forEach(a=>{const l=document.createElement("div");l.className=`piece-cell ${a?"filled":""}`,n.appendChild(l)})}),t.appendChild(n)}this.handContainer.appendChild(t)}))}animateClears(e){return new Promise(i=>{const s=[];e.rows.forEach(t=>{this.container.querySelectorAll(`.grid-cell[data-y="${t}"]`).forEach(r=>s.push(r))}),e.cols.forEach(t=>{this.container.querySelectorAll(`.grid-cell[data-x="${t}"]`).forEach(r=>s.push(r))}),s.forEach(t=>{t.classList.add("clearing")}),setTimeout(()=>{i()},500)})}updatePreview(e,i,s=[],t=[]){this.clearPreview(),e.forEach(n=>{const r=this.container.querySelector(`.grid-cell[data-x="${n.x}"][data-y="${n.y}"]`);r&&(r.classList.add("preview"),r.classList.add(i?"valid":"invalid"))}),i&&(s.forEach(n=>{this.container.querySelectorAll(`.grid-cell[data-y="${n}"]`).forEach(a=>a.classList.add("preview-clear"))}),t.forEach(n=>{this.container.querySelectorAll(`.grid-cell[data-x="${n}"]`).forEach(a=>a.classList.add("preview-clear"))}))}clearPreview(){this.container.querySelectorAll(".preview, .preview-clear").forEach(i=>{i.classList.remove("preview","valid","invalid","preview-clear")})}updateScore(e){this.scoreElement&&(this.scoreElement.innerText=`Score: ${e}`)}updateRounds(e){this.roundElement&&(this.roundElement.innerText=`Round: ${e}`)}showInterstitialGameOver(e,i){if(this.interstitialPopup){const s=Math.floor(i/60),t=i%60,n=`${s}:${t.toString().padStart(2,"0")}`;this.interstitialPopup.innerHTML=`
                <div class="interstitial-content">
                    <h2 class="interstitial-title">Game Over!</h2>
                    <div class="interstitial-stats">
                        <div class="stat-box">
                            <span class="stat-label">Score</span>
                            <span class="stat-value primary">${e}</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Time</span>
                            <span class="stat-value secondary">${n}</span>
                        </div>
                    </div>
                    <button class="restart-btn pulse-btn">Play Again</button>
                </div>
            `;const r=this.interstitialPopup.querySelector(".restart-btn");r.onclick=()=>{window.dispatchEvent(new CustomEvent("request-restart"))},this.interstitialPopup.style.display="flex"}}hideGameOver(){this.interstitialPopup&&(this.interstitialPopup.style.display="none")}}console.log("Tetroku.io initializing...");const C=document.querySelector("#app"),w=new P(C),E=new y(w);E.start();window.addEventListener("request-restart",()=>{E.restart()});
